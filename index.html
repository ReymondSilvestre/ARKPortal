<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ark Portal - SMS Pro Elite</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
--primary: #2c3e50; --secondary: #34495e; --accent: #18bc9c;
--bg: #f4f7f6; --danger: #e74c3c; --info: #3498db; --warning: #f39c12;
--white: #ffffff; --border: #dfe6e9;
}
body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); color: #333; }
nav { background: var(--primary); color: white; padding: 0.8rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
.role-nav-container { display: flex; align-items: center; gap: 20px; }
.sub-nav { background: var(--white); border-bottom: 1px solid var(--border); padding: 10px 2rem; display: flex; gap: 15px; overflow-x: auto; }
.sub-nav button { background: #eee; color: #555; font-size: 13px; padding: 6px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; flex-shrink: 0; }
.sub-nav button.active { background: var(--accent); color: white; }
.container { max-width: 1200px; margin: 1.5rem auto; padding: 0 1rem; }
.card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #eee; }
.hidden { display: none !important; }
button { border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600; transition: 0.2s; }
button:hover { opacity: 0.9; }
.btn-main { background: var(--accent); color: white; }
.btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
.btn-danger { background: var(--danger); color: white; }
.btn-info { background: var(--info); color: white; }
input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
.role-tag { font-size: 0.7rem; background: var(--danger); padding: 4px 10px; border-radius: 20px; color: white; margin-left: 10px; text-transform: uppercase; }
table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; margin-top: 10px; }
table th, table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
table th { background: #f8fafb; color: var(--primary); }
.action-btns { display: flex; gap: 5px; }
.action-btns button { padding: 5px 10px; font-size: 12px; }
#stu-schedule-img { max-width: 100%; border-radius: 8px; border: 2px solid var(--border); }
.breakdown-item { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
.fee-tag { background: #f1f2f6; padding: 2px 8px; border-radius: 4px; font-size: 11px; color: #666; margin-right: 5px; }
nav { display: flex; align-items: center; }
nav .logo { height: 30px; margin-right: 10px; }
</style>
</head>
<body>
<nav>
<div style="display: flex; align-items: center;">
<img id="school-logo" src="" alt="" class="hidden" style="height:30px; margin-right:10px;">
<h2 id="school-name" style="margin:0">Ark Portal</h2>
</div>
<div id="auth-ui">
<button id="login-btn" class="btn-main">Secure Login</button>
<div id="user-info" class="hidden role-nav-container">
<span id="user-display">
<span id="user-name"></span><span id="user-role" class="role-tag"></span>
</span>
<button id="logout-btn" style="background:#95a5a6;">Logout</button>
</div>
</div>
</nav>
<div id="nav-menus">
<div id="admin-menu" class="sub-nav hidden">
<button onclick="showSubPage('admin', 'admin-users-page', this)" class="active">User Management</button>
<button onclick="showSubPage('admin', 'admin-logs-page', this)">System Logs</button>
<button onclick="showSubPage('admin', 'admin-settings-page', this)">Settings</button>
</div>
<div id="registrar-menu" class="sub-nav hidden">
<button onclick="showSubPage('registrar', 'enrollment-page', this)" class="active">Enrollment</button>
<button onclick="showSubPage('registrar', 'masterlist-page', this)">Masterlist & CRUD</button>
<button onclick="showSubPage('registrar', 'requests-page', this)">Document Requests</button>
<button onclick="showSubPage('registrar', 'schedule-page', this)">Post Schedule</button>
</div>
<div id="teacher-menu" class="sub-nav hidden">
<button onclick="showSubPage('teacher', 'grading-page', this)" class="active">Grading Portal</button>
</div>
<div id="finance-menu" class="sub-nav hidden">
<button onclick="showSubPage('finance', 'collections-page', this)" class="active">Collect Payment</button>
<button onclick="showSubPage('finance', 'assessment-page', this)">Fee Assessments</button>
<button onclick="showSubPage('finance', 'history-page', this)">Payment History</button>
<button onclick="showSubPage('finance', 'finance-settings-page', this)">Settings</button>
</div>
<div id="student-menu" class="sub-nav hidden">
<button onclick="showSubPage('student', 'stu-profile-page', this)" class="active">My Profile</button>
<button onclick="showSubPage('student', 'stu-grades-page', this)">Grades</button>
<button onclick="showSubPage('student', 'stu-schedule-page', this)">Schedule</button>
<button onclick="showSubPage('student', 'stu-payments-page', this)">Payments</button>
<button onclick="showSubPage('student', 'stu-requests-page', this)">Request Documents</button>
</div>
</div>
<div class="container">
<div id="guest-view" class="card hidden" style="text-align:center; padding: 50px;">
<h2>Access Pending</h2>
<p>Please wait for the Administrator to assign your role.</p>
</div>
<section id="admin-view" class="view hidden">
<div id="admin-users-page" class="sub-view">
<div class="card">
<h3>System User Control</h3>
<input type="text" id="admin-search" placeholder="Search users by name, email, or role..." onkeyup="filterAdminUsers()">
<div id="user-list-admin" style="margin-top:15px;"></div>
</div>
</div>
<div id="admin-logs-page" class="sub-view hidden">
<div class="card"><h3>System Activity</h3><p>Log tracking coming soon...</p></div>
</div>
<div id="admin-settings-page" class="sub-view hidden">
<div class="card">
<h3>General Settings</h3>
<input type="text" id="admin-school-name" placeholder="School Name">
<input type="text" id="admin-logo-url" placeholder="Logo URL (paste image link)">
<button onclick="saveGeneralSettings()" class="btn-main" style="width:100%; margin-top:10px;">Save Settings</button>
</div>
</div>
</section>
<section id="registrar-view" class="view hidden">
<div id="enrollment-page" class="sub-view">
<div class="card">
<h3>New Student Enrollment</h3>
<div class="grid">
<input type="text" id="reg-lrn" placeholder="LRN">
<select id="reg-voucher">
<option value="NON-VOUCHER">Non-Voucher</option>
<option value="PUB">Public (PUB)</option>
<option value="ALS">ALS</option>
<option value="ESC">ESC</option>
</select>
<input type="text" id="reg-lname" placeholder="Last Name">
<input type="text" id="reg-fname" placeholder="First Name">
<input type="email" id="reg-email" placeholder="Student's Google Email">
</div>
<button id="enroll-btn" class="btn-main" style="width:100%; margin-top:20px;">ENROLL & CREATE ACCOUNT</button>
</div>
</div>
<div id="masterlist-page" class="sub-view hidden">
<div class="card">
<h3>Student Masterlist</h3>
<div style="overflow-x:auto;">
<table>
<thead><tr><th>LRN</th><th>Name</th><th>Email</th><th>Actions</th></tr></thead>
<tbody id="masterlist-body"></tbody>
</table>
</div>
</div>
</div>
<div id="requests-page" class="sub-view hidden">
<div class="card">
<h3>Document Requests</h3>
<input type="text" id="request-search" placeholder="Search by Student Name or Email..." onkeyup="filterRequests()" style="margin-bottom:15px;">
<div id="pending-requests">
<h4>Pending Requests</h4>
<div id="admin-request-list"></div>
</div>
<div id="completed-requests" style="margin-top:20px;">
<h4>Completed Requests</h4>
<div id="released-docs-list"></div>
</div>
</div>
</div>
<div id="schedule-page" class="sub-view hidden">
<div class="card">
<h3>Broadcast Schedule</h3>
<input type="text" id="sched-img-input" placeholder="Paste Image URL here">
<button id="update-sched-btn" class="btn-main">Update Schedule</button>
</div>
</div>
</section>
<section id="teacher-view" class="view hidden">
<div id="grading-page" class="sub-view">
<div class="card">
<h3>Subject: <span id="assigned-subject-title" style="color:var(--accent)"></span></h3>
<div class="grid">
<select id="grade-student-select"></select>
<input type="number" id="grade-value" placeholder="Enter Grade">
<button id="save-grade-btn" class="btn-main">Post Grade</button>
</div>
</div>
</div>
</section>
<section id="finance-view" class="view hidden">
<div id="collections-page" class="sub-view">
<div class="card">
<h3>Collect Payment</h3>
<div class="grid">
<div>
<select id="pay-student-select"></select>
<input type="number" id="pay-amount" placeholder="Amount">
<select id="pay-category">
<option value="Tuition Fee">Tuition Fee</option>
<option value="Misc. Fee">Misc. Fee</option>
<option value="Lab Fee">Lab Fee</option>
<option value="Uniform">Uniform</option>
<option value="Others">Others</option>
</select>
<button id="pay-btn" class="btn-main" style="width:100%">Record Payment</button>
</div>
</div>
</div>
</div>
<div id="assessment-page" class="sub-view hidden">
<div class="card">
<h3>Detailed Fee Assessment</h3>
<p><small>Update specific fee components for each student. The total will update automatically.</small></p>
<input type="text" id="finance-assessment-search" placeholder="Filter by Student Name or Email..." onkeyup="filterAssessment()" style="margin-bottom: 15px;">
<div style="overflow-x:auto;">
<table>
<thead>
<tr>
<th>Student</th>
<th>Current Total</th>
<th>Fee Breakdown</th>
<th>Action</th>
</tr>
</thead>
<tbody id="finance-assessment-list"></tbody>
</table>
</div>
</div>
</div>
<div id="history-page" class="sub-view hidden">
<div class="card">
<h3>Payment History</h3>
<input type="text" id="finance-history-search" placeholder="Filter by Student Name or Email..." onkeyup="filterFinanceHistory()" style="margin-bottom: 15px;">
<div style="overflow-x:auto;">
<table id="finance-log-table">
<thead>
<tr>
<th>Date</th>
<th>Student Email</th>
<th>Amount</th>
<th>Category</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="finance-log"></tbody>
</table>
</div>
</div>
</div>
<div id="finance-settings-page" class="sub-view hidden">
<div class="card">
<h3>Voucher Templates</h3>
<div id="voucher-list" class="grid"></div>
</div>
</div>
</section>
<section id="student-view" class="view hidden">
<div id="stu-profile-page" class="sub-view">
<div class="grid">
<div class="card">
<h3>Student Information</h3>
<div id="stu-info-display"></div>
</div>
<div class="card" style="background:var(--primary); color:white; text-align:center;">
<small>Outstanding Balance</small>
<h1 id="stu-balance">₱0.00</h1>
<hr style="opacity: 0.2">
<div id="stu-breakdown-display" style="text-align: left; font-size: 13px; margin-top: 10px;"></div>
</div>
</div>
</div>
<div id="stu-grades-page" class="sub-view hidden">
<div class="card">
<h3>Grades</h3>
<table><thead><tr><th>Subject</th><th>Grade</th></tr></thead><tbody id="stu-grade-body"></tbody></table>
</div>
</div>
<div id="stu-schedule-page" class="sub-view hidden">
<div class="card"><h3>Class Schedule</h3><img id="stu-schedule-img" src="" alt="No schedule posted"></div>
</div>
<div id="stu-payments-page" class="sub-view hidden">
<div class="card"><h3>Payment History</h3><div id="stu-receipt-list"></div></div>
</div>
<div id="stu-requests-page" class="sub-view hidden">
<div class="card">
<h3>Request Documents</h3>
<select id="stu-req-type">
<option value="Good Moral">Good Moral</option>
<option value="Form 137">Form 137</option>
</select>
<button id="stu-req-btn" class="btn-main">Submit Request</button>
<div id="stu-my-requests" style="margin-top:20px;"></div>
</div>
</div>
</section>
</div>
<div id="fee-modal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:2000;">
<div class="card" style="width:400px; padding:20px;">
<h3>Edit Fee Breakdown for <span id="modal-student-name"></span></h3>
<div id="fee-list"></div>
<div style="display:flex; gap:10px; margin-top:10px;">
<input id="new-fee-name" placeholder="Fee Name">
<input id="new-fee-amount" type="number" placeholder="Amount">
<button onclick="addFeeItem()" class="btn-main">Add</button>
</div>
<div style="margin-top:20px; text-align:right;">
<button id="save-fee-btn" onclick="saveFeeBreakdown()" class="btn-main">Save</button>
<button onclick="closeModal()" class="btn-outline">Cancel</button>
</div>
</div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, addDoc, onSnapshot, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
const firebaseConfig = {
apiKey: "AIzaSyBE3E0D0Z6M1Q-FyOi5AhxwZvShML9b8BM",
authDomain: "arkportal-b8792.firebaseapp.com",
projectId: "arkportal-b8792",
storageBucket: "arkportal-b8792.firebasestorage.app",
messagingSenderId: "429586298160",
appId: "1:429586298160:web:e1197f3b266d76013ac4f5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
let currentUser = null;
let currentStudentId = null;
let currentVoucherType = null;
let financeStudentsCache = [];
let VOUCHER_TEMPLATES = {
'NON-VOUCHER': {'tuition': 10000, 'misc fee': 900, 'intrams fee': 200, 'uniform': 1000, 'p.e uniform': 1000},
'PUB': {'tuition': 0, 'misc fee': 900, 'intrams fee': 200, 'uniform': 0, 'p.e uniform': 0},
'ALS': {'tuition': 0, 'misc fee': 900, 'intrams fee': 200, 'uniform': 0, 'p.e uniform': 0},
'ESC': {'tuition': 7000, 'misc fee': 900, 'intrams fee': 200, 'uniform': 1000, 'p.e uniform': 1000}
};
onAuthStateChanged(auth, async (user) => {
if (user) {
let userRef = doc(db, "users", user.uid);
let snap = await getDoc(userRef);
if (!snap.exists()) {
const preCreatedRef = doc(db, "users", user.email);
const preSnap = await getDoc(preCreatedRef);
if (preSnap.exists()) {
const data = preSnap.data();
await setDoc(userRef, { ...data, uid: user.uid });
await deleteDoc(preCreatedRef);
snap = await getDoc(userRef);
}
}
if (user.email === "reymonde.silvestre@gmail.com") {
await setDoc(userRef, { name: user.displayName, email: user.email, role: 'admin' }, { merge: true });
snap = await getDoc(userRef);
} else if (!snap.exists()) {
await setDoc(userRef, { name: user.displayName, email: user.email, role: 'guest' });
snap = await getDoc(userRef);
}
currentUser = snap.data();
currentUser.uid = user.uid;
renderView(currentUser);
loadGeneralSettings();
} else {
document.getElementById('login-btn').classList.remove('hidden');
document.getElementById('user-info').classList.add('hidden');
document.querySelectorAll('.view, .sub-nav').forEach(v => v.classList.add('hidden'));
}
});
async function loadGeneralSettings() {
const snap = await getDoc(doc(db, "settings", "general"));
if (snap.exists()) {
const data = snap.data();
document.getElementById('school-name').innerText = data.schoolName || 'Ark Portal';
if (data.logoUrl) {
document.getElementById('school-logo').src = data.logoUrl;
document.getElementById('school-logo').classList.remove('hidden');
}
}
}
function renderView(user) {
document.getElementById('login-btn').classList.add('hidden');
document.getElementById('user-info').classList.remove('hidden');
document.getElementById('user-name').innerText = user.name;
document.getElementById('user-role').innerText = user.role?.toUpperCase() || 'GUEST';
document.querySelectorAll('.view, .sub-nav').forEach(v => v.classList.add('hidden'));
const mainView = document.getElementById(`${user.role}-view`) || document.getElementById('guest-view');
if (mainView) mainView.classList.remove('hidden');
const subNav = document.getElementById(`${user.role}-menu`);
if (subNav) subNav.classList.remove('hidden');
if (user.role === 'admin') initAdmin();
if (user.role === 'registrar') initRegistrar();
if (user.role === 'teacher') initTeacher(user);
if (user.role === 'finance') initFinance();
if (user.role === 'student') initStudent(user);
}
window.showSubPage = (role, pageId, btn) => {
document.querySelectorAll(`#${role}-view .sub-view`).forEach(v => v.classList.add('hidden'));
document.getElementById(pageId).classList.remove('hidden');
document.querySelectorAll(`#${role}-menu button`).forEach(b => b.classList.remove('active'));
btn.classList.add('active');
};
// ────────────────────────────────────────────────
// ADMIN
// ────────────────────────────────────────────────
function initAdmin() {
onSnapshot(collection(db, "users"), (snap) => {
const container = document.getElementById('user-list-admin');
container.innerHTML = snap.docs.map(d => {
const u = d.data();
const docId = d.id;
return `
<div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:10px 15px;">
<div>
<strong>$$   {u.name || '—'}</strong> <span class="role-tag" style="background:#7f8c8d">   $${u.role || 'guest'}</span><br>
<small>${u.email}</small>
</div>
<div style="display:flex; gap:10px; align-items:center;">
${u.role === 'teacher' ? `<input type="text" placeholder="Subject" id="sub-${docId}" value="${u.subject || ''}" style="width:100px; margin:0; padding:5px;">` : ''}
<select onchange="updateUserRole('${docId}', this.value)" style="width:110px; margin:0; padding:5px;">
<option value="">Change Role...</option>
<option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
<option value="registrar" ${u.role === 'registrar' ? 'selected' : ''}>Registrar</option>
<option value="teacher" ${u.role === 'teacher' ? 'selected' : ''}>Teacher</option>
<option value="finance" ${u.role === 'finance' ? 'selected' : ''}>Finance</option>
<option value="student" ${u.role === 'student' ? 'selected' : ''}>Student</option>
</select>
<button onclick="modifyUserName('$$   {docId}', '   $${(u.name || '').replace(/'/g,"\\'")}')" class="btn-info" style="padding:5px 10px;">Edit</button>
<button onclick="deleteUserAccount('${docId}')" class="btn-danger" style="padding:5px 10px;">Delete</button>
${u.role === 'teacher' ? `<button onclick="assignSubject('${docId}')" class="btn-main" style="padding:5px 10px;">Save Subj</button>` : ''}
</div>
</div>`;
}).join('');
});
onSnapshot(doc(db, "settings", "general"), (snap) => {
if (snap.exists()) {
const data = snap.data();
document.getElementById('admin-school-name').value = data.schoolName || '';
document.getElementById('admin-logo-url').value = data.logoUrl || '';
}
});
}
window.saveGeneralSettings = async () => {
const schoolName = document.getElementById('admin-school-name').value.trim();
const logoUrl = document.getElementById('admin-logo-url').value.trim();
if (!schoolName) return alert('School name required');
await setDoc(doc(db, "settings", "general"), { schoolName, logoUrl }, { merge: true });
alert('Settings saved! Refresh to see changes.');
document.getElementById('school-name').innerText = schoolName;
if (logoUrl) {
document.getElementById('school-logo').src = logoUrl;
document.getElementById('school-logo').classList.remove('hidden');
} else {
document.getElementById('school-logo').classList.add('hidden');
}
};
window.modifyUserName = async (id, currentName) => {
const newName = prompt("Update User Display Name:", currentName);
if (newName && newName.trim()) {
await updateDoc(doc(db, "users", id), { name: newName.trim() });
alert("Name updated.");
}
};
window.deleteUserAccount = async (id) => {
if (confirm("DANGER: Are you sure? This will permanently delete the portal access for this user.")) {
await deleteDoc(doc(db, "users", id));
alert("User deleted.");
}
};
window.updateUserRole = async (id, role) => {
if (!role) return;
await updateDoc(doc(db, "users", id), { role });
alert("Role Updated!");
};
window.assignSubject = async (id) => {
const sub = document.getElementById(`sub-${id}`).value.trim();
await updateDoc(doc(db, "users", id), { subject: sub });
alert("Subject Assigned!");
};
window.filterAdminUsers = () => {
const q = document.getElementById('admin-search').value.toLowerCase();
document.querySelectorAll('#user-list-admin .card').forEach(card => {
card.style.display = card.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
});
};
// ────────────────────────────────────────────────
// REGISTRAR
// ────────────────────────────────────────────────
function initRegistrar() {
onSnapshot(query(collection(db, "users"), where("role", "==", "student")), (snap) => {
document.getElementById('masterlist-body').innerHTML = snap.docs.map(d => {
const s = d.data();
return `<tr><td>$$   {s.lrn || '-'}</td><td>   $${s.name || '—'}</td><td>${s.email}</td>
<td><button onclick="deleteUserAccount('${d.id}')" class="btn-danger">Remove</button></td></tr>`;
}).join('');
});
onSnapshot(collection(db, "requests"), (snap) => {
document.getElementById('admin-request-list').innerHTML = snap.docs.map(d => `
<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
<div><strong>${d.data().studentName || '—'}</strong>: ${d.data().type}</div>
<button onclick="releaseDocument('${d.id}')" class="btn-main">Mark Released</button>
</div>`).join('');
});
onSnapshot(query(collection(db, "released_docs"), orderBy("timestamp", "desc")), (snap) => {
document.getElementById('released-docs-list').innerHTML = snap.docs.map(d => {
const data = d.data();
return `
<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
<div><strong>${data.studentName || '—'}</strong>: ${data.type} (Released: ${data.date})</div>
</div>`;
}).join('');
});
document.getElementById('update-sched-btn').onclick = async () => {
const url = document.getElementById('sched-img-input').value.trim();
if (url) {
await setDoc(doc(db, "settings", "schedule"), { imgUrl: url });
alert('Schedule updated!');
} else {
alert('Please enter a valid image URL');
}
};
}
window.releaseDocument = async (id) => {
const snap = await getDoc(doc(db, "requests", id));
if (snap.exists()) {
const data = snap.data();
await addDoc(collection(db, "released_docs"), { ...data, date: new Date().toLocaleDateString(), timestamp: new Date() });
await deleteDoc(doc(db, "requests", id));
alert("Document released!");
}
};
window.filterRequests = () => {
const q = document.getElementById('request-search').value.toLowerCase();
document.querySelectorAll('#admin-request-list .card, #released-docs-list .card').forEach(card => {
card.style.display = card.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
});
};
document.getElementById('enroll-btn').onclick = async () => {
const email = document.getElementById('reg-email').value.trim();
if (!email) return alert("Email required!");
const name = `${document.getElementById('reg-lname').value.trim()}, ${document.getElementById('reg-fname').value.trim()}`.trim();
await setDoc(doc(db, "users", email), {
lrn: document.getElementById('reg-lrn').value.trim(),
name: name || "Unnamed Student",
email: email,
role: 'student',
totalAssessment: 0,
feeBreakdown: {},
voucher: document.getElementById('reg-voucher').value
});
alert("Enrolled!");
};
// ────────────────────────────────────────────────
// TEACHER
// ────────────────────────────────────────────────
function initTeacher(user) {
document.getElementById('assigned-subject-title').innerText = user.subject || "Not Assigned";
onSnapshot(query(collection(db, "users"), where("role", "==", "student")), (snap) => {
document.getElementById('grade-student-select').innerHTML = snap.docs.map(d => {
const s = d.data();
return `<option value="${s.email}">${s.name || s.email}</option>`;
}).join('');
});
}
document.getElementById('save-grade-btn').onclick = async () => {
if (!currentUser.subject) return alert("No assigned subject!");
const studentEmail = document.getElementById('grade-student-select').value;
const grade = document.getElementById('grade-value').value.trim();
if (!studentEmail || !grade) return alert("Select student and enter grade");
await addDoc(collection(db, "grades"), {
studentEmail,
subject: currentUser.subject,
grade,
timestamp: new Date()
});
alert("Grade Saved!");
document.getElementById('grade-value').value = "";
};
// ────────────────────────────────────────────────
// FINANCE
// ────────────────────────────────────────────────
function refreshFinanceAssessment() {
const container = document.getElementById('finance-assessment-list');
if (!container) return;
container.innerHTML = financeStudentsCache.map(s => {
const fb = s.feeBreakdown || {};
const breakdownDisplay = Object.entries(fb)
.map(([k, v]) => `<div style="display:flex; justify-content:space-between; font-size:12px;">
<span>$$   {k.charAt(0).toUpperCase() + k.slice(1)}:</span> ₱   $${Number(v).toLocaleString()}</div>`)
.join('') || '<small style="color:#999">No fees set</small>';
return `
<tr>
<td><strong>$$   {s.name || '—'}</strong><br><small>   $${s.email}</small><br><span class="role-tag" style="background:#2980b9; font-size:10px;">${s.voucher || 'No Voucher'}</span></td>
<td>₱${Number(s.totalAssessment || 0).toLocaleString()}</td>
<td>${breakdownDisplay}</td>
<td><button onclick="openFeeModal('${s.id}')" class="btn-main">Edit Breakdown</button></td>
</tr>`;
}).join('');
}
function renderVoucherList() {
const container = document.getElementById('voucher-list');
container.innerHTML = Object.keys(VOUCHER_TEMPLATES).map(type => {
const fb = VOUCHER_TEMPLATES[type] || {};
const breakdownDisplay = Object.entries(fb)
.map(([k, v]) => `<div style="display:flex; justify-content:space-between; font-size:12px;">
<span>$$   {k.charAt(0).toUpperCase() + k.slice(1)}:</span> ₱   $${Number(v).toLocaleString()}</div>`)
.join('') || '<small>No fees set</small>';
return `
<div class="card">
<h4>${type}</h4>
${breakdownDisplay}
<button onclick="openVoucherModal('${type}')" class="btn-main" style="margin-top:10px;">Edit</button>
</div>`;
}).join('');
}
function initFinance() {
onSnapshot(query(collection(db, "users"), where("role", "==", "student")), (snap) => {
financeStudentsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
document.getElementById('pay-student-select').innerHTML = financeStudentsCache
.map(s => `<option value="${s.email}">${s.name || s.email}</option>`)
.join('');
refreshFinanceAssessment();
});
onSnapshot(query(collection(db, "payments"), orderBy("timestamp", "desc")), (snap) => {
document.getElementById('finance-log').innerHTML = snap.docs.map(d => {
const p = d.data();
return `
<tr data-student="${p.studentEmail}">
<td>${p.date}</td>
<td>${p.studentEmail}</td>
<td>₱${Number(p.amount || 0).toLocaleString()}</td>
<td>${p.category}</td>
<td class="action-btns">
<button onclick="editPayment('${d.id}', ${Number(p.amount || 0)})" class="btn-info">Edit</button>
<button onclick="deletePayment('${d.id}')" class="btn-danger">Delete</button>
</td>
</tr>`;
}).join('');
});
onSnapshot(doc(db, "settings", "vouchers"), (snap) => {
if (snap.exists()) {
VOUCHER_TEMPLATES = { ...VOUCHER_TEMPLATES, ...snap.data() };
}
renderVoucherList();
});
}
window.openFeeModal = (id) => {
const student = financeStudentsCache.find(s => s.id === id);
if (!student) return;
currentStudentId = id;
currentVoucherType = null;
document.getElementById('modal-student-name').innerText = (student.name || student.email) + ` (${student.voucher || 'No Voucher'})`;
let fb = student.feeBreakdown || {};
if (Object.keys(fb).length === 0 && student.voucher && VOUCHER_TEMPLATES[student.voucher]) {
fb = { ...VOUCHER_TEMPLATES[student.voucher] };
}
document.getElementById('fee-list').innerHTML = Object.entries(fb).map(([key, val]) => `
<div class="breakdown-item">
<span class="fee-tag">${key.charAt(0).toUpperCase() + key.slice(1)}</span>
<input type="number" value="$$   {Number(val)}" data-name="   $${key.toLowerCase()}">
<button onclick="removeFeeItem(this)" class="btn-danger" style="padding:2px 6px;">X</button>
</div>
`).join('') || '<p style="color:#999">No fees yet. Add below.</p>';
document.getElementById('fee-modal').classList.remove('hidden');
};
window.openVoucherModal = (type) => {
currentVoucherType = type;
currentStudentId = null;
document.getElementById('modal-student-name').innerText = `${type} Voucher Template`;
const fb = VOUCHER_TEMPLATES[type] || {};
document.getElementById('fee-list').innerHTML = Object.entries(fb).map(([key, val]) => `
<div class="breakdown-item">
<span class="fee-tag">${key.charAt(0).toUpperCase() + key.slice(1)}</span>
<input type="number" value="$$   {Number(val)}" data-name="   $${key.toLowerCase()}">
<button onclick="removeFeeItem(this)" class="btn-danger" style="padding:2px 6px;">X</button>
</div>
`).join('') || '<p style="color:#999">No fees yet. Add below.</p>';
document.getElementById('fee-modal').classList.remove('hidden');
};
window.closeModal = () => {
document.getElementById('fee-modal').classList.add('hidden');
currentStudentId = null;
currentVoucherType = null;
};
window.addFeeItem = () => {
const name = document.getElementById('new-fee-name').value.trim().toLowerCase();
const amount = document.getElementById('new-fee-amount').value.trim();
if (!name || !amount || isNaN(amount)) return alert('Enter valid fee name and amount');
document.getElementById('fee-list').innerHTML += `
<div class="breakdown-item">
<span class="fee-tag">${name.charAt(0).toUpperCase() + name.slice(1)}</span>
<input type="number" value="$$   {Number(amount)}" data-name="   $${name}">
<button onclick="removeFeeItem(this)" class="btn-danger" style="padding:2px 6px;">X</button>
</div>
`;
document.getElementById('new-fee-name').value = '';
document.getElementById('new-fee-amount').value = '';
};
window.removeFeeItem = (btn) => {
btn.parentElement.remove();
};
window.saveFeeBreakdown = async () => {
const saveBtn = document.getElementById('save-fee-btn');
saveBtn.disabled = true;
saveBtn.textContent = "Saving...";
try {
const items = document.querySelectorAll('#fee-list .breakdown-item');
const fb = {};
let total = 0;
items.forEach(item => {
const name = item.querySelector('input').dataset.name;
const amount = Number(item.querySelector('input').value) || 0;
if (name && amount >= 0) {
fb[name] = amount;
if (currentStudentId) total += amount;
}
});
if (currentVoucherType) {
await setDoc(doc(db, "settings", "vouchers"), { [currentVoucherType]: fb }, { merge: true });
VOUCHER_TEMPLATES[currentVoucherType] = fb;
renderVoucherList();
alert("Voucher template updated!");
} else if (currentStudentId) {
await updateDoc(doc(db, "users", currentStudentId), {
feeBreakdown: fb,
totalAssessment: total
});
alert("Fee breakdown updated!");
refreshFinanceAssessment();
}
closeModal();
} catch (err) {
console.error("Save error:", err);
alert("Failed to save: " + (err.message || "Unknown error"));
} finally {
saveBtn.disabled = false;
saveBtn.textContent = "Save";
}
};
window.filterAssessment = () => {
const q = document.getElementById('finance-assessment-search').value.toLowerCase();
document.querySelectorAll('#finance-assessment-list tr').forEach(row => {
row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
});
};
window.filterFinanceHistory = () => {
const q = document.getElementById('finance-history-search').value.toLowerCase();
document.querySelectorAll('#finance-log tr').forEach(row => {
row.style.display = row.innerText.toLowerCase().includes(q) ? 'table-row' : 'none';
});
};
window.deletePayment = async (id) => {
if (confirm("Confirm Delete? Student balance will update.")) {
await deleteDoc(doc(db, "payments", id));
alert("Payment deleted.");
}
};
window.editPayment = async (id, currentAmount) => {
const newAmt = prompt("Update Payment Amount:", currentAmount);
if (newAmt !== null && !isNaN(newAmt) && Number(newAmt) >= 0) {
await updateDoc(doc(db, "payments", id), { amount: Number(newAmt) });
alert("Payment updated.");
}
};
document.getElementById('pay-btn').onclick = async () => {
const amt = document.getElementById('pay-amount').value.trim();
if (!amt || isNaN(amt) || Number(amt) <= 0) return alert("Enter valid amount");
await addDoc(collection(db, "payments"), {
studentEmail: document.getElementById('pay-student-select').value,
amount: Number(amt),
category: document.getElementById('pay-category').value,
date: new Date().toLocaleDateString(),
timestamp: new Date()
});
alert("Payment Recorded!");
document.getElementById('pay-amount').value = "";
};
// ────────────────────────────────────────────────
// STUDENT
// ────────────────────────────────────────────────
async function initStudent(user) {
onSnapshot(doc(db, "users", user.uid), async (s) => {
if (!s.exists()) return;
const d = s.data();
document.getElementById('stu-info-display').innerHTML = `
<p><strong>$$   {d.name || '—'}</strong><br>   $${d.email}<br>LRN: ${d.lrn || 'N/A'}</p>`;
const fb = d.feeBreakdown || {};
document.getElementById('stu-breakdown-display').innerHTML = `
<div style="font-weight:bold; margin-bottom:5px;">Fee Breakdown:</div>
${Object.entries(fb).map(([k,v]) => `
<div style="display:flex; justify-content:space-between;">
<span>${k.charAt(0).toUpperCase() + k.slice(1)}:</span>
<span>₱${Number(v).toLocaleString()}</span>
</div>`).join('')}
<hr style="opacity:0.2">
<div style="display:flex; justify-content:space-between; font-weight:bold;">
<span>Total Required:</span>
<span>₱${Number(d.totalAssessment || 0).toLocaleString()}</span>
</div>
`;
const pSnap = await getDocs(query(collection(db, "payments"), where("studentEmail", "==", user.email)));
let paid = 0;
let receipts = "";
pSnap.forEach(p => {
const data = p.data();
paid += Number(data.amount || 0);
receipts += `<div class="card" style="padding:10px; margin-bottom:5px; font-size:13px;">
<strong>${data.date}</strong> - $$   {data.category}: ₱   $${Number(data.amount || 0).toLocaleString()}
</div>`;
});
const balance = Number(d.totalAssessment || 0) - paid;
document.getElementById('stu-balance').innerText = `₱${balance.toLocaleString()}`;
document.getElementById('stu-receipt-list').innerHTML = receipts || "<p>No payment records found.</p>";
});
onSnapshot(query(collection(db, "grades"), where("studentEmail", "==", user.email)), (snap) => {
document.getElementById('stu-grade-body').innerHTML = snap.docs.map(d => {
const g = d.data();
return `<tr><td>${g.subject}</td><td>${g.grade}</td></tr>`;
}).join('') || '<tr><td colspan="2">No grades yet</td></tr>';
});
onSnapshot(doc(db, "settings", "schedule"), (s) => {
if (s.exists() && s.data().imgUrl) {
document.getElementById('stu-schedule-img').src = s.data().imgUrl;
}
});
}
document.getElementById('stu-req-btn').onclick = async () => {
const type = document.getElementById('stu-req-type').value;
await addDoc(collection(db, "requests"), {
studentEmail: currentUser.email,
studentName: currentUser.name,
type,
timestamp: new Date()
});
alert("Request Sent!");
};
// ────────────────────────────────────────────────
// GLOBAL
// ────────────────────────────────────────────────
document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => location.reload());
window.deleteUserAccount = deleteUserAccount;
window.modifyUserName = modifyUserName;
window.updateUserRole = updateUserRole;
window.assignSubject = assignSubject;
window.deletePayment = deletePayment;
window.editPayment = editPayment;
window.openFeeModal = openFeeModal;
window.openVoucherModal = openVoucherModal;
window.closeModal = closeModal;
window.addFeeItem = addFeeItem;
window.removeFeeItem = removeFeeItem;
window.saveFeeBreakdown = saveFeeBreakdown;
window.saveGeneralSettings = saveGeneralSettings;
</script>
</body>
</html>
