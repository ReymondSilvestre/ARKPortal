<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ark Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* ───────── YOUR ORIGINAL STYLES (UNCHANGED) ───────── */
:root {
    --primary:#2c3e50;--secondary:#34495e;--accent:#18bc9c;
    --bg:#f4f7f6;--danger:#e74c3c;--info:#3498db;
    --white:#fff;--border:#dfe6e9;
}
body{margin:0;font-family:Segoe UI;background:var(--bg)}
.hidden{display:none!important}
nav{background:var(--primary);color:#fff;padding:12px 24px;display:flex;justify-content:space-between;align-items:center}
.sub-nav{background:#fff;border-bottom:1px solid var(--border);padding:8px 24px;display:flex;gap:10px}
.sub-nav button{border:none;padding:6px 14px;border-radius:5px;font-weight:600}
.sub-nav button.active{background:var(--accent);color:#fff}
.container{max-width:1200px;margin:auto;padding:20px}
.card{background:#fff;padding:20px;border-radius:10px;margin-bottom:20px}
button{cursor:pointer}
.btn-main{background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:5px}
.btn-danger{background:var(--danger);color:#fff;border:none}
.btn-info{background:var(--info);color:#fff;border:none}
input,select{width:100%;padding:10px;margin:6px 0}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px}
.breakdown-item{display:flex;gap:10px;align-items:center;margin-bottom:5px}
.fee-tag{background:#eee;padding:3px 8px;border-radius:4px;font-size:12px}
</style>
</head>

<body>

<nav>
<h2 id="school-title">Ark Portal</h2>
<div>
<button id="login-btn" class="btn-main">Login</button>
<button id="logout-btn" class="btn-danger hidden">Logout</button>
</div>
</nav>

<!-- ───────── NAV MENUS ───────── -->
<div id="admin-menu" class="sub-nav hidden">
<button onclick="showSub('admin-users',this)" class="active">Users</button>
<button onclick="showSub('admin-settings',this)">Settings</button>
</div>

<div id="finance-menu" class="sub-nav hidden">
<button onclick="showSub('finance-collect',this)" class="active">Collect</button>
<button onclick="showSub('finance-assess',this)">Assess</button>
<button onclick="showSub('finance-settings',this)">Settings</button>
</div>

<div id="registrar-menu" class="sub-nav hidden">
<button onclick="showSub('reg-requests',this)" class="active">Requests</button>
</div>

<div class="container">

<!-- ───────── ADMIN VIEW ───────── -->
<section id="admin-view" class="hidden">

<div id="admin-users" class="sub-view card">
<h3>User Management</h3>
<div id="admin-users-list"></div>
</div>

<div id="admin-settings" class="sub-view card hidden">
<h3>School Settings</h3>
<input id="school-name" placeholder="School Name">
<input id="school-logo" placeholder="School Logo URL">
<button class="btn-main" onclick="saveSchoolSettings()">Save</button>
</div>

</section>

<!-- ───────── FINANCE VIEW ───────── -->
<section id="finance-view" class="hidden">

<div id="finance-collect" class="sub-view card">
<h3>Collect Payment</h3>
<p>(unchanged)</p>
</div>

<div id="finance-assess" class="sub-view card hidden">
<h3>Fee Assessment</h3>
<p>(unchanged)</p>
</div>

<div id="finance-settings" class="sub-view card hidden">
<h3>Voucher Templates</h3>

<select id="voucher-select" onchange="loadVoucherTemplate()">
<option value="PUB">PUB</option>
<option value="ESC">ESC</option>
<option value="NON-VOUCHER">NON-VOUCHER</option>
</select>

<div id="voucher-fee-list"></div>

<div style="display:flex;gap:10px">
<input id="voucher-fee-name" placeholder="Fee Name">
<input id="voucher-fee-amount" type="number" placeholder="Amount">
<button class="btn-main" onclick="addVoucherFee()">Add</button>
</div>

<button class="btn-main" style="margin-top:10px" onclick="saveVoucherTemplate()">Save Template</button>
</div>

</section>

<!-- ───────── REGISTRAR VIEW ───────── -->
<section id="registrar-view" class="hidden">

<div id="reg-requests" class="sub-view card">
<h3>Document Requests</h3>
<input id="request-filter" placeholder="Search student..." onkeyup="filterRequests()">
<div id="request-list"></div>
</div>

</section>

</div>

<!-- ───────── FIREBASE + LOGIC ───────── -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
getFirestore,doc,getDoc,setDoc,updateDoc,deleteDoc,
collection,addDoc,onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
getAuth,signInWithPopup,GoogleAuthProvider,onAuthStateChanged,signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
apiKey:"AIzaSyBE3E0D0Z6M1Q-FyOi5AhxwZvShML9b8BM",
authDomain:"arkportal-b8792.firebaseapp.com",
projectId:"arkportal-b8792"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);
const provider=new GoogleAuthProvider();

let role=null;
let currentVoucher="PUB";

/* ───────── AUTH ───────── */
login-btn.onclick=()=>signInWithPopup(auth,provider);
logout-btn.onclick=()=>signOut(auth).then(()=>location.reload());

onAuthStateChanged(auth,async u=>{
if(!u)return;
logout-btn.classList.remove("hidden");
login-btn.classList.add("hidden");

if(u.email==="reymonde.silvestre@gmail.com"){
role="admin";
admin-menu.classList.remove("hidden");
admin-view.classList.remove("hidden");
loadAdmin();
}
});

/* ───────── NAV SWITCH ───────── */
window.showSub=(id,btn)=>{
btn.parentElement.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
btn.closest("section").querySelectorAll(".sub-view").forEach(v=>v.classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
};

/* ───────── ADMIN SETTINGS ───────── */
async function saveSchoolSettings(){
await setDoc(doc(db,"settings","school"),{
name:school-name.value,
logo:school-logo.value
});
alert("Saved");
}

onSnapshot(doc(db,"settings","school"),s=>{
if(s.exists()){
school-title.innerText=s.data().name||"Ark Portal";
}
});

/* ───────── FINANCE SETTINGS ───────── */
window.loadVoucherTemplate=async()=>{
currentVoucher=voucher-select.value;
voucher-fee-list.innerHTML="";
const snap=await getDoc(doc(db,"voucher_settings",currentVoucher));
if(!snap.exists())return;
Object.entries(snap.data().fees||{}).forEach(([k,v])=>{
voucher-fee-list.innerHTML+=`
<div class="breakdown-item">
<span class="fee-tag">${k}</span>
<input type="number" value="${v}" data-name="${k}">
<button class="btn-danger" onclick="this.parentElement.remove()">X</button>
</div>`;
});
};

window.addVoucherFee=()=>{
voucher-fee-list.innerHTML+=`
<div class="breakdown-item">
<span class="fee-tag">${voucher-fee-name.value}</span>
<input type="number" value="${voucher-fee-amount.value}" data-name="${voucher-fee-name.value}">
<button class="btn-danger" onclick="this.parentElement.remove()">X</button>
</div>`;
};

window.saveVoucherTemplate=async()=>{
const fees={};
voucher-fee-list.querySelectorAll("input").forEach(i=>{
fees[i.dataset.name]=Number(i.value);
});
await setDoc(doc(db,"voucher_settings",currentVoucher),{fees});
alert("Template Saved");
};

/* ───────── REGISTRAR REQUESTS ───────── */
onSnapshot(collection(db,"requests"),snap=>{
request-list.innerHTML=snap.docs.map(d=>{
const r=d.data();
return `<div class="card">
<strong>${r.studentName}</strong> - ${r.type}
<button class="btn-main" onclick="completeRequest('${d.id}')">Complete</button>
</div>`;
}).join("");
});

window.completeRequest=async id=>{
const ref=doc(db,"requests",id);
const snap=await getDoc(ref);
await addDoc(collection(db,"completed_requests"),snap.data());
await deleteDoc(ref);
};

window.filterRequests=()=>{
const q=request-filter.value.toLowerCase();
request-list.querySelectorAll(".card").forEach(c=>{
c.style.display=c.innerText.toLowerCase().includes(q)?"block":"none";
});
};
</script>
</body>
</html>
